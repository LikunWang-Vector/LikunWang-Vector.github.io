---
title: "24. å®æˆ˜ï¼šç”¨å¼‚æ­¥æ³•è·å–å®Œæ•´çš„ä¸€éƒ¨å°è¯´"
date: 2023-01-11
updated: 2023-01-11
categories:
  - Pythonçˆ¬è™«å…¥é—¨ã€è¿›é˜¶ä¸å®æˆ˜
tags:
  - çˆ¬è™«
  - å¼‚æ­¥çˆ¬è™«
  - asyncio
  - aiohttp
  - aiofiles
csdn_views: 793
csdn_likes: 7
csdn_comments: 8
csdn_favorites: 8
csdn_url: https://blog.csdn.net/m0_59180666/article/details/128649022
cover: /images/posts/24.-å®æˆ˜ï¼šç”¨å¼‚æ­¥æ³•è·å–å®Œæ•´çš„ä¸€éƒ¨å°è¯´/013093aa699c.png
lang_pair:
  en: "24. Practical: Async Scraping a Complete Novel"
---

> æœ¬æ–‡è¿ç§»è‡ªCSDNåšå®¢
> åŸæ–‡é“¾æ¥ï¼š[24. å®æˆ˜ï¼šç”¨å¼‚æ­¥æ³•è·å–å®Œæ•´çš„ä¸€éƒ¨å°è¯´](https://blog.csdn.net/m0_59180666/article/details/128649022)
> ğŸ“Š 793 é˜…è¯» | ğŸ‘ 7 ç‚¹èµ | ğŸ’¬ 8 è¯„è®º | â­ 8 æ”¶è—

**ç›®å½•**

å‰è¨€ URL**ï¼ˆåœ¨è¯„è®ºåŒºï¼‰** URL**ï¼ˆåœ¨è¯„è®ºåŒºï¼‰** URL**ï¼ˆåœ¨è¯„è®ºåŒºï¼‰** URL**ï¼ˆåœ¨è¯„è®ºåŒºï¼‰**

ç›®çš„ URL**ï¼ˆåœ¨è¯„è®ºåŒºï¼‰** URL**ï¼ˆåœ¨è¯„è®ºåŒºï¼‰** URL**ï¼ˆåœ¨è¯„è®ºåŒºï¼‰** URL**ï¼ˆåœ¨è¯„è®ºåŒºï¼‰**

æ€è·¯ URL**ï¼ˆåœ¨è¯„è®ºåŒºï¼‰** URL**ï¼ˆåœ¨è¯„è®ºåŒºï¼‰** URL**ï¼ˆåœ¨è¯„è®ºåŒºï¼‰** URL**ï¼ˆåœ¨è¯„è®ºåŒºï¼‰**

ä»£ç å®ç°

1\. å°è¯•è·å–å°è¯´å†…å®¹çš„URLï¼ˆåœ¨è¯„è®ºåŒºï¼‰

2\. æŸ¥çœ‹é¡µé¢æºä»£ç 

3\. æŠ“åŒ…å·¥å…·ç™»åœº

4\. å¼€å§‹å†™ä»£ç ï¼Œå…ˆæ‹æ¸…æ€è·¯

5\. å®Œå–„getCatalogå‡½æ•°

6\. å®Œå–„aiodownloadå‡½æ•°

å®Œæ•´ä»£ç 

è¿è¡Œæ•ˆæœ

æ€»ç»“

* * *

### å‰è¨€

æˆ‘ä»¬å·²ç»å­¦ä¼šäº†å¼‚æ­¥çˆ¬è™«çš„æ¡†æ¶å’Œç®€å•çš„ç¤ºä¾‹ï¼Œè¯¦è§[23\. å¼‚æ­¥HTTPè¯·æ±‚ä¸aiohttpæ¨¡å—](https://blog.csdn.net/m0_59180666/article/details/128640512 "23. å¼‚æ­¥HTTPè¯·æ±‚ä¸aiohttpæ¨¡å—")ã€‚

æœ¬èŠ‚æˆ‘ä»¬é€šè¿‡ä¸€ä¸ªå®æˆ˜æ¥å·©å›ºå¼‚æ­¥çˆ¬è™«çš„ç”¨æ³•ï¼šæŠ“å–æ•´éƒ¨å°è¯´çš„å†…å®¹ã€‚

* * *

### ç›®çš„

åˆ©ç”¨å¼‚æ­¥çˆ¬è™«é«˜æ•ˆçˆ¬å–æ•´éƒ¨å°è¯´

* * *

### æ€è·¯

  1. è·å–å°è¯´å†…å®¹çš„url
  2. è·å–ç½‘é¡µæ•°æ®
  3. ä¿å­˜åˆ°æœ¬åœ°

* * *

### ä»£ç å®ç°

#### 1\. å°è¯•è·å–å°è¯´å†…å®¹çš„URL**ï¼ˆåœ¨è¯„è®ºåŒºï¼‰**

![](/images/posts/24.-å®æˆ˜ï¼šç”¨å¼‚æ­¥æ³•è·å–å®Œæ•´çš„ä¸€éƒ¨å°è¯´/013093aa699c.png)

æ‰“å¼€ç½‘é¡µï¼ˆ**ç½‘é¡µé“¾æ¥æ”¾è¯„è®ºåŒºäº†ï¼ï¼ï¼** ï¼‰ï¼Œå‘ç°ç›®å½•ç­‰å†…å®¹ï¼Œç‚¹å‡»ç« èŠ‚å°±èƒ½è·³è½¬åˆ°å¯¹åº”å†…å®¹ä¸­ã€‚æˆ‘ä»¬å…ˆæ£€æŸ¥é¡µé¢æºä»£ç æŸ¥çœ‹æ•°æ®æ˜¯å¦åœ¨æºä»£ç ä¸­ã€‚

#### 2\. æŸ¥çœ‹é¡µé¢æºä»£ç 

![](/images/posts/24.-å®æˆ˜ï¼šç”¨å¼‚æ­¥æ³•è·å–å®Œæ•´çš„ä¸€éƒ¨å°è¯´/695bb5539228.png)

å¯ä»¥çœ‹åˆ°æºä»£ç æ‰ä¸åˆ°30è¡Œï¼Œæˆ‘ä»¬çš„æ•°æ®è‚¯å®šä¸åœ¨è¿™é‡Œé¢...

é‚£æˆ‘ä»¬åªèƒ½ç¥­å‡º**F12å¤§æ³•ï¼šæŠ“åŒ…å·¥å…·** ç™»åœºã€‚

#### 3\. æŠ“åŒ…å·¥å…·ç™»åœº

![](/images/posts/24.-å®æˆ˜ï¼šç”¨å¼‚æ­¥æ³•è·å–å®Œæ•´çš„ä¸€éƒ¨å°è¯´/255bd7512ec9.png)

åˆ‡æ¢åˆ°ç½‘ç»œâ€”â€”Fetch/XHRâ€”â€”åˆ·æ–°é¡µé¢å°±å¾—åˆ°äº†è¿™ä¸‰ä¸ªåŠ¨æ€è¯·æ±‚ã€‚æ‰“å¼€getCatalogï¼ˆè·å–ç›®å½•ï¼‰ï¼Œç‚¹å‡»é¢„è§ˆï¼Œå°±èƒ½çœ‹åˆ°ä¸€å¤§å †åç§°äº†ï¼Œè¿™å°±æ˜¯æˆ‘ä»¬è¦æ‹¿çš„æ‰€æœ‰ç« èŠ‚åç§°å’Œå®ƒçš„idäº†ã€‚ä½†æ˜¯å†…å®¹è¿˜æ²¡æœ‰å‡ºç°ã€‚

![](/images/posts/24.-å®æˆ˜ï¼šç”¨å¼‚æ­¥æ³•è·å–å®Œæ•´çš„ä¸€éƒ¨å°è¯´/ecd1d750ec0e.png)

åˆ‡æ¢åˆ°ä¸‹ä¸€ä¸ªgetChapterContentï¼ˆè·å–ç« èŠ‚å†…å®¹ï¼‰ï¼Œæ‰“å¼€æœç„¶å‘ç°äº†æ–‡æœ¬ï¼è¿™å°±æ˜¯æˆ‘ä»¬è¦çš„å†…å®¹ã€‚

æœ€ååˆ‡æ¢åˆ°æ ‡å¤´ï¼Œå°±èƒ½è·å–åˆ°æˆ‘ä»¬çš„ç›®æ ‡URLå’Œè¯·æ±‚æ–¹å¼ç­‰ä¿¡æ¯ã€‚

è¯·æ±‚æ–¹å¼ï¼š

> GET

#### 4\. å¼€å§‹å†™ä»£ç ï¼Œå…ˆæ‹æ¸…æ€è·¯

```python """ 1\. åŒæ­¥æ“ä½œ: è®¿é—®getCatalog æ‹¿åˆ°æ‰€æœ‰ç« èŠ‚çš„cidå’Œåç§° 2\. å¼‚æ­¥æ“ä½œ: è®¿é—®getChapterContent ä¸‹è½½æ‰€æœ‰çš„æ–‡ç« å†…å®¹ """ ``` 

æˆ‘ä»¬å¾—åˆ°çš„URLæœ€åæœ‰ä¸€å †â€œä¹±ç â€ï¼Œä½†å…¶å®æˆ‘ä»¬å‘ç°è¿˜æ˜¯æœ‰è§„å¾‹çš„ã€‚ä¸€èˆ¬URLåé¢éƒ½ä¼šåŠ é—®å·å’Œå±æ€§åŠ å±æ€§å€¼ã€‚ä½†æˆ‘ä»¬ç°åœ¨è¿™ä¸ªURLä¸èµ°å¯»å¸¸è·¯ï¼Œä½†æ˜¯ä»”ç»†è§‚å¯Ÿé‡Œé¢æœ‰ä¸€å †â€œ%22â€ï¼Œå®ƒæ˜¯ä»€ä¹ˆå‘¢ï¼Ÿ

**å…¶å®ï¼Œå®ƒå°±æ˜¯ASCIIç ä¸­çš„åŒå¼•å·ã€‚å‚é˜…[ç™¾åº¦ç™¾ç§‘](https://baike.baidu.com/item/URL%E7%BC%96%E7%A0%81/3703727?fr=aladdin "ç™¾åº¦ç™¾ç§‘")**ã€‚å®ƒåŒ…å«ç€URLæ‰€éœ€è¦çš„å‚æ•°ã€‚

æ€è·¯æ˜ç¡®ä»¥åå…ˆç”»å‡ºä¸€ä¸ªæ¡†æ¶ï¼š

```python async def aiodownload(cid, b_id, title): pass async def getCatalog(url): pass if __name__ == '__main__': b_id = "4306063500" url = 'http://dushu.ï¼Ÿï¼Ÿï¼Ÿï¼Ÿ.com/api/pc/getCatalog?data={"book_id":"' + b_id + '"}' asyncio.run(getCatalog(url)) ``` 

#### 5\. å®Œå–„getCatalogå‡½æ•°

```python async def getCatalog(url): resp = requests.get(url) dic = resp.json() tasks = [] for item in dic['data']['novel']['items']: # itemå°±æ˜¯å¯¹åº”æ¯ä¸€ä¸ªç« èŠ‚çš„åç§°å’Œcid title = item['title'] cid = item['cid'] # å‡†å¤‡å¼‚æ­¥ä»»åŠ¡ tasks.append(aiodownload(cid, b_id, title)) await asyncio.wait(tasks) ``` 

å…ˆæŠŠè¿”å›å€¼è½¬ä¸ºjsonæ•°æ®ï¼Œç„¶åä»ä¸­æå–titleå’Œcidä¸¤é¡¹å±æ€§ï¼Œç„¶åæŠŠå‚æ•°ä¼ å…¥aiodownloadå‡½æ•°ã€‚

ï¼ˆä¸­é—´è°ƒè¯•ç¨‹åºã€æ‰“å°å‡ºjsonæ•°æ®å†…å®¹ã€ä¸€å±‚å±‚æ‰¾åˆ°è¦çš„å±æ€§å°±ä¸å¤šè®²äº†ï¼‰

#### 6\. å®Œå–„aiodownloadå‡½æ•°

```python async def aiodownload(cid, b_id, title): data = { "book_id": b_id, "cid": f"{b_id}|{cid}", "need_bookinfo": 1 } data = json.dumps(data) url = f"http://dushu.ï¼Ÿï¼Ÿï¼Ÿï¼Ÿ.com/api/pc/getChapterContent?data={data}" async with aiohttp.ClientSession() as session: async with session.get(url) as resp: dic = await resp.json() chapter = dic['data']['novel']['chapter_index'] async with aiofiles.open(f"./Novel_Journey_to_the_West/{chapter}_{title}", mode="w", encoding="GB18030") as f: await f.write(dic['data']['novel']['content']) # æŠŠå°è¯´å†…å®¹å†™å‡º ``` 

æˆ‘ä»¬è§‚å¯Ÿç›®æ ‡URLå‘ç°ï¼Œå®ƒéœ€è¦ä¼ å…¥çš„æ•°æ®æœ‰ä¸‰é¡¹ï¼Œåˆ†åˆ«æ˜¯book_idã€cidã€need_bookinfoã€‚

è¿™é‡Œæˆ‘ä»¬çš„æ•°æ®æ˜¯å­—å…¸å½¢å¼ï¼Œä½†æ˜¯æˆ‘ä»¬è¦æƒ³å†™åˆ°URLä¸­å°±å¿…é¡»è½¬ä¸ºå­—ç¬¦ä¸²å½¢å¼ï¼Œå°±è¦ç”¨åˆ°dumpsè¿™ä¸ªæ¥å£ã€‚æŸ¥çœ‹å®˜æ–¹æ–‡æ¡£ï¼š

> 
>     Serialize ``obj`` to a JSON formatted ``str``

å®ƒçš„å«ä¹‰å°±æ˜¯æŠŠjsonæ•°æ®è½¬æ¢ä¸ºåˆè§„çš„å­—ç¬¦ä¸²å½¢å¼ã€‚

ä¸ºäº†é˜²æ­¢è¾“å…¥ä»¥åè¿˜æ˜¯ä¹±åºï¼Œæˆ‘ä»¬å†æ‹¿å‡ºä¸€ä¸ªchapter_indexè¿™ä¸ªå±æ€§ï¼Œå®ƒæ˜¯æ•°å­—å½¢å¼çš„é¡ºåºï¼Œè¿™æ ·å°±å¯ä»¥æ”¾åœ¨æ–‡ä»¶åå¼€å§‹ï¼Œä¸‹è½½å®ŒæˆæŒ‰åç§°æ’åºå°±èƒ½æŒ‰é¡ºåºäº†ï¼

* * *

### å®Œæ•´ä»£ç 

```python import requests import asyncio import aiohttp import aiofiles import json """ 1\. åŒæ­¥æ“ä½œ: è®¿é—®getCatalog æ‹¿åˆ°æ‰€æœ‰ç« èŠ‚çš„cidå’Œåç§° 2\. å¼‚æ­¥æ“ä½œ: è®¿é—®getChapterContent ä¸‹è½½æ‰€æœ‰çš„æ–‡ç« å†…å®¹ """ async def aiodownload(cid, b_id, title): data = { "book_id": b_id, "cid": f"{b_id}|{cid}", "need_bookinfo": 1 } data = json.dumps(data) url = f"http://dushu.ï¼Ÿï¼Ÿï¼Ÿï¼Ÿ.com/api/pc/getChapterContent?data={data}" async with aiohttp.ClientSession() as session: async with session.get(url) as resp: dic = await resp.json() chapter = dic['data']['novel']['chapter_index'] async with aiofiles.open(f"./Novel_Journey_to_the_West/{chapter}_{title}", mode="w", encoding="GB18030") as f: await f.write(dic['data']['novel']['content']) # æŠŠå°è¯´å†…å®¹å†™å‡º async def getCatalog(url): resp = requests.get(url) dic = resp.json() # print(dic) tasks = [] for item in dic['data']['novel']['items']: # itemå°±æ˜¯å¯¹åº”æ¯ä¸€ä¸ªç« èŠ‚çš„åç§°å’Œcid title = item['title'] cid = item['cid'] # å‡†å¤‡å¼‚æ­¥ä»»åŠ¡ tasks.append(aiodownload(cid, b_id, title)) await asyncio.wait(tasks) if __name__ == '__main__': b_id = "4306063500" url = 'http://dushu.ï¼Ÿï¼Ÿï¼Ÿï¼Ÿ.com/api/pc/getCatalog?data={"book_id":"' + b_id + '"}' asyncio.run(getCatalog(url)) ``` 

* * *

### è¿è¡Œæ•ˆæœ

![](/images/posts/24.-å®æˆ˜ï¼šç”¨å¼‚æ­¥æ³•è·å–å®Œæ•´çš„ä¸€éƒ¨å°è¯´/67c850ac2e99.png)

![](/images/posts/24.-å®æˆ˜ï¼šç”¨å¼‚æ­¥æ³•è·å–å®Œæ•´çš„ä¸€éƒ¨å°è¯´/a820eab99f24.png)

* * *

### æ€»ç»“

æœ¬èŠ‚æˆ‘ä»¬å­¦ä¹ äº†å¼‚æ­¥çˆ¬è™«çš„å®æˆ˜ï¼Œçˆ¬å–äº†ä¸€æ•´æœ¬å°è¯´ï¼ˆè¿™é‡Œæˆ‘ä»¥è¥¿æ¸¸è®°ä¸ºä¾‹ï¼Œå¤§å®¶å¯ä»¥è‡ªå·±çˆ¬ç‚¹åˆ«çš„ï¼Œæ¢URLå°±è¡Œäº†ï¼‰ã€‚ä¸‹é¢æˆ‘ä»¬å°†å­¦ä¹ è§†é¢‘çš„æŠ“å–ï¼ˆm3u8æ ¼å¼ï¼‰ã€‚
